<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üêÑ CowSay Kids ‚Äî ÿ®ÿ≥ŸÖ ÿßŸÑŸÑŸá</title>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=VT323&family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a1628;
  --card: #0f2035;
  --accent: #d4a843;
  --accent2: #1a8a7d;
  --text: #f0e6d0;
  --text-muted: #8a9ab5;
  --key-bg: #162a45;
  --key-hover: #1a3a5c;
  --border: #d4a843;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  min-height: 100vh;
  background: var(--bg);
  color: var(--text);
  font-family: 'Fredoka', 'Segoe UI', sans-serif;
  overflow-x: hidden;
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: rgba(212,168,67,0.3); border-radius: 3px; }

/* ===== SPLASH ===== */
#splash {
  position: fixed; inset: 0; z-index: 9999;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  background: var(--bg);
  transition: opacity 0.8s ease, visibility 0.8s;
}
#splash.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
#splash .bism {
  font-family: 'Amiri', serif; font-size: clamp(26px, 5vw, 52px);
  color: var(--accent); animation: fadeInUp 1s ease;
}
#splash .salam {
  font-size: clamp(14px, 2.5vw, 22px); color: var(--text-muted);
  margin-top: 12px; animation: fadeInUp 1.5s ease;
}

/* ===== ISLAMIC GEOMETRIC OVERLAY ===== */
#geo-overlay {
  position: fixed; inset: 0; pointer-events: none; z-index: 0; opacity: 0.035;
}

/* ===== MAIN APP ===== */
#app {
  position: relative; z-index: 1;
  max-width: 920px; margin: 0 auto; padding: 0 12px 20px;
  display: flex; flex-direction: column; gap: 10px;
  animation: fadeInUp 0.5s ease 2.3s both;
}

/* Header */
header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 4px; border-bottom: 1px solid rgba(212,168,67,0.15);
  flex-wrap: wrap; gap: 8px;
}
.logo { display: flex; align-items: center; gap: 8px; }
.logo-icon { font-size: 26px; }
.logo-title { font-family: 'Amiri', serif; font-size: 22px; color: var(--accent); font-weight: 700; }
.logo-bism { font-family: 'Amiri', serif; font-size: 12px; color: var(--text-muted); }
.header-controls { display: flex; gap: 5px; align-items: center; flex-wrap: wrap; }
.header-sep { width: 1px; height: 20px; background: rgba(212,168,67,0.25); }

/* ===== BUTTONS ===== */
.top-btn {
  padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 13px;
  border: 1px solid rgba(212,168,67,0.25); background: var(--key-bg); color: var(--text);
  transition: all 0.15s; font-family: inherit; white-space: nowrap;
}
.top-btn:hover { background: var(--key-hover); }
.top-btn.active { background: rgba(212,168,67,0.2); border-color: var(--accent); color: var(--accent); }

.param-btn {
  padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 13px;
  border: 1px solid rgba(212,168,67,0.25); background: var(--key-bg); color: var(--text);
  transition: all 0.15s; white-space: nowrap; font-family: inherit;
}
.param-btn:hover { background: var(--key-hover); border-color: rgba(212,168,67,0.5); }
.param-btn.active { background: rgba(212,168,67,0.2); border-color: var(--accent); color: var(--accent); }

.quick-key {
  padding: 4px 10px; border-radius: 20px; cursor: pointer; font-size: 13px;
  border: 1px solid rgba(212,168,67,0.3); background: rgba(212,168,67,0.08);
  color: var(--accent); transition: all 0.15s; white-space: nowrap;
  font-family: 'Amiri', serif;
}
.quick-key:hover { background: rgba(212,168,67,0.2); border-color: rgba(212,168,67,0.6); }

/* ===== PANEL ===== */
.panel {
  background: var(--card); border: 1px solid rgba(212,168,67,0.12);
  border-radius: 12px; padding: 12px; position: relative;
}

/* ===== OUTPUT ===== */
#output-box { position: relative; overflow: hidden; }
#output-box .arch {
  position: absolute; top: -1px; left: 50%; transform: translateX(-50%);
  width: 140px; height: 8px; border-radius: 0 0 70px 70px;
  background: linear-gradient(90deg, transparent, rgba(212,168,67,0.3), transparent);
}
/* Decorative corner ornaments */
#output-box .corner { position: absolute; font-size: 16px; color: var(--accent); opacity: 0.2; line-height: 1; }
#output-box .corner.tl { top: 6px; left: 8px; }
#output-box .corner.tr { top: 6px; right: 8px; }
#output-box .corner.bl { bottom: 30px; left: 8px; }
#output-box .corner.br { bottom: 30px; right: 8px; }

#output-pre {
  font-family: 'VT323', 'Courier New', monospace; font-size: clamp(11px, 1.9vw, 15px);
  line-height: 1.35; white-space: pre; overflow-x: auto;
  padding: 20px 16px; min-height: 170px; color: var(--text);
  direction: ltr; text-align: left;
}
#output-actions { display: flex; gap: 8px; margin-top: 8px; }

/* ===== PARAMS ===== */
.params-row { display: flex; gap: 8px; flex-wrap: wrap; }
.param-group { flex: 1 1 auto; min-width: 0; }
.param-group.fixed { flex: 0 0 auto; }
.section-label {
  font-size: 11px; color: var(--text-muted); text-transform: uppercase;
  letter-spacing: 1px; margin-bottom: 5px;
}
.btn-row { display: flex; gap: 4px; flex-wrap: wrap; }

/* ===== DROPDOWNS ===== */
.dropdown-wrap { position: relative; }
.dropdown {
  position: absolute; top: 100%; margin-top: 4px; background: var(--card);
  border: 1px solid rgba(212,168,67,0.25); border-radius: 10px; padding: 6px;
  z-index: 100; min-width: 220px; max-height: 300px; overflow-y: auto;
  animation: fadeInUp 0.2s ease; box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  display: none;
}
.dropdown.open { display: block; }
.drop-item {
  display: flex; align-items: center; gap: 8px; padding: 7px 10px;
  border-radius: 8px; cursor: pointer; transition: all 0.12s; font-size: 13px;
}
.drop-item:hover { background: var(--key-hover); }
.drop-item.active { background: rgba(212,168,67,0.15); color: var(--accent); }
.drop-swatch {
  width: 16px; height: 16px; border-radius: 4px; display: inline-block;
  border: 2px solid var(--accent);
}

/* ===== EYES / TONGUE GRID ===== */
.eyes-grid { display: flex; gap: 3px; flex-wrap: wrap; }
.eyes-grid .param-btn { font-family: 'VT323', monospace; min-width: 38px; padding: 4px 6px; font-size: 13px; }

/* ===== TEXT INPUT AREA ===== */
#text-display {
  font-family: 'VT323', monospace; font-size: 16px; min-height: 36px;
  padding: 6px 8px; border-bottom: 2px solid rgba(212,168,67,0.25);
  margin-bottom: 8px; word-break: break-word; line-height: 1.4;
}
#text-display .cursor {
  color: var(--accent); animation: blink 1s step-end infinite;
  font-weight: bold;
}
.quick-keys-row { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 8px; }
.toolbar-row { display: flex; gap: 6px; margin-bottom: 10px; flex-wrap: wrap; position: relative; }

/* ===== KEYBOARD ===== */
.kb-row { display: flex; gap: 3px; justify-content: center; margin-bottom: 3px; }
.zellige-key {
  background: var(--key-bg); color: var(--text); border: 1px solid rgba(212,168,67,0.18);
  border-radius: 6px; padding: 8px 4px; min-width: 30px; min-height: 40px;
  cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;
  transition: all 0.12s; user-select: none; font-family: inherit; flex: 1; max-width: 44px;
}
.zellige-key:hover { background: var(--key-hover); border-color: rgba(212,168,67,0.4); transform: translateY(-1px); }
.zellige-key:active { transform: translateY(1px) scale(0.95); background: rgba(212,168,67,0.2); }
.zellige-key.special {
  background: rgba(212,168,67,0.1); color: var(--accent); font-size: 13px;
  max-width: none;
}
.zellige-key.special:hover { background: rgba(212,168,67,0.25); }
.zellige-key.space { max-width: 260px; font-size: 12px; color: var(--text-muted); letter-spacing: 4px; }

/* ===== FOOTER ===== */
footer {
  text-align: center; padding: 10px 0; font-size: 12px; color: var(--text-muted);
  font-family: 'Amiri', serif;
}

/* ===== SLIDER ===== */
input[type="range"] {
  width: 100%; accent-color: var(--accent); height: 4px;
  background: transparent; cursor: pointer;
}

/* ===== ANIMATIONS ===== */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(15px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0; }
}

/* ===== RESPONSIVE ===== */
@media (max-width: 600px) {
  header { padding: 8px 2px; }
  .logo-bism { display: none; }
  .zellige-key { min-height: 36px; font-size: 14px; min-width: 24px; }
  .param-btn { font-size: 12px; padding: 5px 8px; }
  #output-pre { font-size: 10px; padding: 12px 8px; min-height: 130px; }
}
</style>
</head>
<body>

<!-- ===== SPLASH ===== -->
<div id="splash">
  <div class="bism">ÿ®ÿ≥ŸÖ ÿßŸÑŸÑŸá ÿßŸÑÿ±ÿ≠ŸÖŸÜ ÿßŸÑÿ±ÿ≠ŸäŸÖ</div>
  <div class="salam">ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸäŸÉŸÖ üëã</div>
</div>

<!-- ===== GEOMETRIC OVERLAY ===== -->
<svg id="geo-overlay" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <pattern id="islamicGeo" x="0" y="0" width="60" height="60" patternUnits="userSpaceOnUse">
      <polygon points="30,0 60,15 60,45 30,60 0,45 0,15" fill="none" stroke="#d4a843" stroke-width="0.5"/>
      <polygon points="30,10 50,20 50,40 30,50 10,40 10,20" fill="none" stroke="#d4a843" stroke-width="0.3"/>
      <line x1="30" y1="0" x2="30" y2="60" stroke="#d4a843" stroke-width="0.15"/>
      <line x1="0" y1="30" x2="60" y2="30" stroke="#d4a843" stroke-width="0.15"/>
    </pattern>
  </defs>
  <rect width="100%" height="100%" fill="url(#islamicGeo)"/>
</svg>

<!-- ===== MAIN APP ===== -->
<div id="app">
  <!-- Header -->
  <header>
    <div class="logo">
      <span class="logo-icon">üêÑ</span>
      <span class="logo-title" id="app-title">CowSay Kids</span>
      <span class="logo-bism">ÿ®ÿ≥ŸÖ ÿßŸÑŸÑŸá ÿßŸÑÿ±ÿ≠ŸÖŸÜ ÿßŸÑÿ±ÿ≠ŸäŸÖ</span>
    </div>
    <div class="header-controls">
      <button class="top-btn active" data-lang="en" onclick="setLang('en')">üá¨üáß</button>
      <button class="top-btn" data-lang="fr" onclick="setLang('fr')">üá´üá∑</button>
      <button class="top-btn" data-lang="ar" onclick="setLang('ar')">üá∏üá¶</button>
      <span class="header-sep"></span>
      <div class="dropdown-wrap">
        <button class="top-btn" id="theme-btn" onclick="toggleDropdown('theme-dropdown')">üé® <span data-i18n="theme">Theme</span></button>
        <div class="dropdown" id="theme-dropdown"></div>
      </div>
    </div>
  </header>

  <!-- Output Box -->
  <div class="panel" id="output-box">
    <div class="arch"></div>
    <span class="corner tl">‚ú¶</span>
    <span class="corner tr">‚ú¶</span>
    <span class="corner bl">‚ú¶</span>
    <span class="corner br">‚ú¶</span>
    <pre id="output-pre"></pre>
    <div id="output-actions">
      <button class="param-btn" id="copy-btn" onclick="copyOutput()">üìã <span data-i18n="copy">Copy</span></button>
    </div>
  </div>

  <!-- Params Row 1: Character, Mode, Width -->
  <div class="params-row">
    <div class="param-group dropdown-wrap">
      <div class="section-label" data-i18n="character">Character</div>
      <button class="param-btn" id="char-btn" style="width:100%;text-align:left" onclick="toggleDropdown('char-dropdown')">üêÑ Cow</button>
      <div class="dropdown" id="char-dropdown"></div>
    </div>
    <div class="param-group fixed">
      <div class="section-label">Mode</div>
      <div class="btn-row">
        <button class="param-btn active" id="say-btn" onclick="setMode(false)"><span data-i18n="say">üó£Ô∏è Qul! (Say!)</span></button>
        <button class="param-btn" id="think-btn" onclick="setMode(true)"><span data-i18n="think">üí≠ Think</span></button>
      </div>
    </div>
    <div class="param-group fixed" style="min-width:100px">
      <div class="section-label"><span data-i18n="wrapWidth">Width</span>: <span id="wrap-val">30</span></div>
      <input type="range" min="15" max="60" value="30" oninput="setWrapWidth(this.value)">
    </div>
  </div>

  <!-- Mood Row -->
  <div>
    <div class="section-label" data-i18n="mood">Mood</div>
    <div class="btn-row" id="mood-row"></div>
  </div>

  <!-- Eyes & Tongue -->
  <div class="params-row">
    <div class="param-group" style="min-width:200px">
      <div class="section-label" data-i18n="eyes">Eyes</div>
      <div class="eyes-grid" id="eyes-row"></div>
    </div>
    <div class="param-group fixed">
      <div class="section-label" data-i18n="tongue">Tongue</div>
      <div class="eyes-grid" id="tongue-row"></div>
    </div>
  </div>

  <!-- Input & Keyboard Panel -->
  <div class="panel">
    <div id="text-display"><span class="cursor">‚ñè</span></div>

    <!-- Islamic Quick Keys -->
    <div class="quick-keys-row" id="quick-keys"></div>

    <!-- Toolbar -->
    <div class="toolbar-row">
      <div class="dropdown-wrap">
        <button class="param-btn" id="presets-btn" onclick="toggleDropdown('presets-dropdown')">üìù <span data-i18n="presets">Presets</span></button>
        <div class="dropdown" id="presets-dropdown"></div>
      </div>
      <button class="param-btn" onclick="randomCombo()"><span data-i18n="random">üé≤ Random</span></button>
      <button class="param-btn" onclick="clearText()"><span data-i18n="clear">Clear</span></button>
      <button class="param-btn" id="caps-btn" onclick="toggleCaps()">‚á™ CAPS</button>
    </div>

    <!-- Keyboard -->
    <div id="keyboard"></div>
  </div>

  <!-- Footer -->
  <footer>ŸÅŸä ÿ£ŸÖÿßŸÜ ÿßŸÑŸÑŸá ü§≤ ‚Ä¢ CowSay Kids ‚Ä¢ <span data-i18n="mashallah">ŸÖÿß ÿ¥ÿßÿ° ÿßŸÑŸÑŸá!</span></footer>
</div>

<script>
// ========================
// DATA
// ========================
const CHARACTERS = {
  default:     { name:{en:"Cow",fr:"Vache",ar:"ÿ®ŸÇÿ±ÿ©"}, emoji:"üêÑ", art:(e,t)=>`\\   ^__^\n \\  (${e})\\_______\n    (__)\\       )\\/\\\\\n     ${t}  ||----w |\n        ||     ||` },
  tux:         { name:{en:"Tux",fr:"Tux",ar:"ÿ™ÿßŸÉÿ≥"}, emoji:"üêß", art:(e,t)=>`\\\n \\\\\n  .--.\n |${e}|\n |:_/ |\n //   \\\\ \\\\\n(|     | )\n/'\\_   _/\`\\\\\n\\___)=(___/` },
  dragon:      { name:{en:"Dragon",fr:"Dragon",ar:"ÿ™ŸÜŸäŸÜ"}, emoji:"üêâ", art:(e,t)=>`\\                    / \\  //\\\\\n \\    |\\___/|      /   \\\\//  \\\\\\\\\n      /${e}  \\__  /    //  | \\\\ \\\\\n     (  \\     / ) /    //   |  \\\\\n      \\  \\_^_/ / /    //    |   \\\\\n       \\__   //     //     |    \\\\\n        \\|  ||     //      |     \\\\\n         \\  ||    //       |      \\\\\n          \\ ||   //        |       \\\\\n           \\||  //         |        \\\\\n            \\ \\\\//          |         \\\\\n             \\            /           \\\\\\\\\n              |          /             \\\\\\\\\n              |         /               \\\\\\\\` },
  stegosaurus: { name:{en:"Stego",fr:"St√©go",ar:"ÿ≥ÿ™Ÿäÿ∫Ÿà"}, emoji:"ü¶ï", art:(e,t)=>`\\                             .       .\n \\                           / \`.   .' "\n  \\                  .---.  <    > <    >  .---.\n   \\                 |    \\\\  \\\\ - ~ ~ - /  /    |\n         _____          ..-~             ~-..-~\n        |     |   \\\\~~~\\\\.                    ./~~~/\n       ---------   \\\\__/                        \\\\__/\n      .'  O    \\\\     /               /       \\\\  "\n     (_____,    \`._.'               |         }  \\/~~~/\n      \`----.          /       }     |        /    \\\\__/\n            \`-.      |       /      |       /      \`. ,~~|\n                ~-.__|      /_ - ~ ^|      /- _      \`..-'\n                     |     /        |     /     ~-.     \`-. _  _  _\n                     |_____|        |_____|         ~ - . _ _ _ _ _>` },
  elephant:    { name:{en:"Elephant",fr:"√âl√©phant",ar:"ŸÅŸäŸÑ"}, emoji:"üêò", art:(e,t)=>`\\     /\\  ___  /\\\\\n \\   // \\/   \\/ \\\\\\\\\n    ((    ${e}   ))\n     \\\\\\\\  ---  //\n      \\_____/\n       _|  |_\n      / |  | \\\\` },
  sheep:       { name:{en:"Sheep",fr:"Mouton",ar:"ÿÆÿ±ŸàŸÅ"}, emoji:"üêë", art:(e,t)=>`\\  __\n \\ (${e})\n   ('')\\)\n    ||--||` },
  turtle:      { name:{en:"Turtle",fr:"Tortue",ar:"ÿ≥ŸÑÿ≠ŸÅÿßÿ©"}, emoji:"üê¢", art:(e,t)=>`\\                  ___-------___\n \\             _-~~             ~~-_\n           _-~                    /~-_\n        /~\\\\                   /    \\\\\n       /    \\\\                 /      |\n      /      |               |       |\n     |       |   _______     |       |\n     |       \\\\  |       \\\\   /        |\n      |       ~-_|       \\_-~         |\n       \\\\                            /\n        \\\\   ${e}                   /\n          \\\\        __________     /\n            ~-___-~          ~---~` },
  kitty:       { name:{en:"Kitty",fr:"Chaton",ar:"ŸÇÿ∑ÿ©"}, emoji:"üê±", art:(e,t)=>`\\\n \\\n  (\`\\ .-') /'  )\n   \` )-'(( _) /\n  (' _)  ) )/\n   (\`__)(\`__)` },
  ghost:       { name:{en:"Ghost",fr:"Fant√¥me",ar:"ÿ¥ÿ®ÿ≠"}, emoji:"üëª", art:(e,t)=>`\\\n \\\n  .-\"\"\"\"\"-.\n / .===. \\\\\n \\/ ${e[0]} ${e[1]} \\/\n  ( ._. )\n   \`---'` },
  cheese:      { name:{en:"Cheese",fr:"Fromage",ar:"ÿ¨ÿ®ŸÜÿ©"}, emoji:"üßÄ", art:(e,t)=>`\\\n \\\n   /     \\_/\\\\\n  |  ${e}    ||\n  |  .___. ||\n  |  |   | ||\n  |__|   |_||` },
  bunny:       { name:{en:"Bunny",fr:"Lapin",ar:"ÿ£ÿ±ŸÜÿ®"}, emoji:"üê∞", art:(e,t)=>`\\   \\\\\\\\\n \\   \\\\\\\\\n      \\\\\\\\\n       \\\\\\\\\n        >\\\\\n       / \\\\\\\\\n      /  ||\n     *   ||\n     |   ||\n     |   ||\n      ~..||` },
  moose:       { name:{en:"Moose",fr:"√âlan",ar:"ŸÖŸàÿ∏"}, emoji:"ü´é", art:(e,t)=>`\\\n \\   \\_\\_    _/_/\n  \\      \\__/\n         (${e})\\______\n         (__)\\        )\\/\\\\\n      ${t}     |-----|\n             |     |` },
  duck:        { name:{en:"Duck",fr:"Canard",ar:"ÿ®ÿ∑ÿ©"}, emoji:"ü¶Ü", art:(e,t)=>`\\\n \\  _\n  >(${e})__\n   (     )\\\\\n    |---| \\\\\n    |   |  *\n    ^   ^` },
  skeleton:    { name:{en:"Skeleton",fr:"Squelette",ar:"ŸáŸäŸÉŸÑ"}, emoji:"üíÄ", art:(e,t)=>`\\\n \\   .-.\n  \\ (${e})   .-)\n   ( OO  ) / |\n   / |  | \\  |\n  ( /|  |\\ \\-\"\n   \\|  |/ \\\\\n    '  '   |` },
  small:       { name:{en:"Mini",fr:"Mini",ar:"ÿµÿ∫Ÿäÿ±ÿ©"}, emoji:"üêÑ", art:(e,t)=>`\\   ,__,\n \\  (${e})____\n    (__)    )\\\\\n     ${t} ||--|| *` },
  camel:       { name:{en:"Camel",fr:"Chameau",ar:"ÿ¨ŸÖŸÑ"}, emoji:"üê™", art:(e,t)=>`\\\n \\    //\n  \\  (${e})\n    \\(  )\\   ~~\n     ( __ )\\  /\n      \"  \" \\/\n       |  |\n       ^  ^` },
  whale:       { name:{en:"Whale",fr:"Baleine",ar:"ÿ≠Ÿàÿ™"}, emoji:"üêã", art:(e,t)=>`\\\n \\\n    .------------.\n   /  ${e}  ______   \\\\\n  |  /        \\   |\n  | |          |  |\n   \\ \\________/  /\n    '------------'` },
  fox:         { name:{en:"Fox",fr:"Renard",ar:"ÿ´ÿπŸÑÿ®"}, emoji:"ü¶ä", art:(e,t)=>`\\\n \\  /\\   /\\\\\n  \\ {${e}} /\n   (  ‚Ä¢  )\n   /    |\\\\\n  (_\\  /_)` },
  owl:         { name:{en:"Owl",fr:"Hibou",ar:"ÿ®ŸàŸÖÿ©"}, emoji:"ü¶â", art:(e,t)=>`\\\n \\  ___\n  \\ {${e}}\n   ( v )\n   /| |\\\\\n  (_| |_)` },
  goat:        { name:{en:"Goat",fr:"Ch√®vre",ar:"ŸÖÿßÿπÿ≤"}, emoji:"üêê", art:(e,t)=>`\\  )__(\n \\ (${e})___\n   ('')\\  )\\\\\n    ||--||` },
  rooster:     { name:{en:"Rooster",fr:"Coq",ar:"ÿØŸäŸÉ"}, emoji:"üêì", art:(e,t)=>`\\\n \\   /\\/\\\\\n  \\ |\\${e}/|\n   ( \\_/ )\n    U   U\n    |   |\n    |___|\n    (   )` },
};

const MOODS = {
  normal:  { eyes:"oo", tongue:"  ", label:{en:"Normal",fr:"Normal",ar:"ÿπÿßÿØŸä"}, emoji:"üòê" },
  borg:    { eyes:"==", tongue:"  ", label:{en:"Borg",fr:"Borg",ar:"ÿ¢ŸÑŸä"}, emoji:"ü§ñ" },
  dead:    { eyes:"xx", tongue:"U ", label:{en:"Dead",fr:"Mort",ar:"ŸÖŸäÿ™"}, emoji:"üíÄ" },
  greedy:  { eyes:"$$", tongue:"  ", label:{en:"Greedy",fr:"Avide",ar:"ÿ∑ŸÖŸëÿßÿπ"}, emoji:"ü§ë" },
  paranoid:{ eyes:"@@", tongue:"  ", label:{en:"Paranoid",fr:"Parano√Øa",ar:"ŸÖÿ±ÿ™ÿßÿ®"}, emoji:"üò∞" },
  dizzy:   { eyes:"**", tongue:"U ", label:{en:"Dizzy",fr:"√âtourdi",ar:"ÿØÿßÿ¶ÿÆ"}, emoji:"üòµ" },
  tired:   { eyes:"--", tongue:"  ", label:{en:"Tired",fr:"Fatigu√©",ar:"ÿ™ÿπÿ®ÿßŸÜ"}, emoji:"üò¥" },
  wired:   { eyes:"OO", tongue:"  ", label:{en:"Wired",fr:"Surexcit√©",ar:"ŸÖŸÜÿ®ŸëŸá"}, emoji:"ü§™" },
  young:   { eyes:"..", tongue:"  ", label:{en:"Young",fr:"Jeune",ar:"ÿµÿ∫Ÿäÿ±"}, emoji:"üë∂" },
};

const CUSTOM_EYES = ["oo","OO","@@","**","$$","^^","><","==","‚ô•‚ô•","‚òÜ‚òÜ","‚óâ‚óâ","##","!!","??","00","~~","‚Ä¢‚Ä¢","‚äô‚äô"];
const CUSTOM_TONGUES = ["  ","U ","J ","L ","P ","‚ô• ","W "];

const KEYBOARDS = {
  en: [
    ["1","2","3","4","5","6","7","8","9","0"],
    ["q","w","e","r","t","y","u","i","o","p"],
    ["a","s","d","f","g","h","j","k","l"],
    ["z","x","c","v","b","n","m"],
  ],
  fr: [
    ["1","2","3","4","5","6","7","8","9","0"],
    ["a","z","e","r","t","y","u","i","o","p"],
    ["q","s","d","f","g","h","j","k","l","m"],
    ["w","x","c","v","b","n","√©","√®","√™","√†"],
  ],
  ar: [
    ["Ÿ°","Ÿ¢","Ÿ£","Ÿ§","Ÿ•","Ÿ¶","Ÿß","Ÿ®","Ÿ©","Ÿ†"],
    ["ÿ∂","ÿµ","ÿ´","ŸÇ","ŸÅ","ÿ∫","ÿπ","Ÿá","ÿÆ","ÿ≠","ÿ¨"],
    ["ÿ¥","ÿ≥","Ÿä","ÿ®","ŸÑ","ÿß","ÿ™","ŸÜ","ŸÖ","ŸÉ"],
    ["ÿ¶","ÿ°","ÿ§","ÿ±","ŸÑÿß","Ÿâ","ÿ©","Ÿà","ÿ≤","ÿØ","ÿ∞"],
    ["ÿ∏","ÿ∑","Ÿë","Ÿã","Ÿå","Ÿç","Ÿé","Ÿè","Ÿê"],
  ],
};

const ISLAMIC_QUICK = [
  {label:"ÿ®ÿ≥ŸÖ ÿßŸÑŸÑŸá",text:"ÿ®ÿ≥ŸÖ ÿßŸÑŸÑŸá ÿßŸÑÿ±ÿ≠ŸÖŸÜ ÿßŸÑÿ±ÿ≠ŸäŸÖ"},
  {label:"ÿ≥ŸÑÿßŸÖ",text:"ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸäŸÉŸÖ"},
  {label:"ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá",text:"ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá"},
  {label:"ÿ≥ÿ®ÿ≠ÿßŸÜ ÿßŸÑŸÑŸá",text:"ÿ≥ÿ®ÿ≠ÿßŸÜ ÿßŸÑŸÑŸá"},
  {label:"ŸÖÿß ÿ¥ÿßÿ° ÿßŸÑŸÑŸá",text:"ŸÖÿß ÿ¥ÿßÿ° ÿßŸÑŸÑŸá"},
  {label:"ÿ•ŸÜ ÿ¥ÿßÿ° ÿßŸÑŸÑŸá",text:"ÿ•ŸÜ ÿ¥ÿßÿ° ÿßŸÑŸÑŸá"},
  {label:"ÿ¨ÿ≤ÿßŸÉ ÿßŸÑŸÑŸá",text:"ÿ¨ÿ≤ÿßŸÉ ÿßŸÑŸÑŸá ÿÆŸäÿ±ÿßŸã"},
  {label:"ÿµŸÑŸâ ÿßŸÑŸÑŸá",text:"ÿµŸÑŸâ ÿßŸÑŸÑŸá ÿπŸÑŸäŸá Ÿàÿ≥ŸÑŸÖ"},
];

const PRESETS = {
  en:["Bismillah! Let's code! üíª","Eid Moo-barak! üêÑüéâ","This cow wakes up for Fajr üåÖ","Al-Khwarizmi invented my algorithm!","404: Grass not found üåø","Knowledge is light! üí°","Patience is the key to relief","SubhanAllah, what a beautiful day!","Jummah Moo-barak! üïå","Ibn al-Haytham invented the camera! üì∑","Who strives shall find! üí™","Even cows make dua ü§≤","Algebra = Al-Jabr = ÿßŸÑÿ¨ÿ®ÿ± üßÆ","This cow fasts Ramadan üåô","I speak fluent binary: 01001101 01101111 01101111"],
  fr:["Bismillah ! Codons ! üíª","A√Ød Meuh-barak ! üêÑüéâ","Cette vache se l√®ve pour Fajr üåÖ","Al-Khwarizmi a invent√© mon algorithme !","Erreur 404 : herbe introuvable üåø","Le savoir est lumi√®re ! üí°","La patience est la cl√©","SubhanAllah, quelle belle journ√©e !","Joumou'a Meuh-barak ! üïå","Ibn al-Haytham a invent√© la cam√©ra ! üì∑"],
  ar:["!ÿ®ÿ≥ŸÖ ÿßŸÑŸÑŸáÿå ŸÑŸÜÿ®ÿ±ŸÖÿ¨ üíª","!ÿπŸäÿØ ŸÖŸàŸàŸà-ÿ®ÿßÿ±ŸÉ üêÑüéâ","Ÿáÿ∞Ÿá ÿßŸÑÿ®ŸÇÿ±ÿ© ÿ™ÿ≥ÿ™ŸäŸÇÿ∏ ŸÑÿµŸÑÿßÿ© ÿßŸÑŸÅÿ¨ÿ± üåÖ","!ÿßŸÑÿÆŸàÿßÿ±ÿ≤ŸÖŸä ÿßÿÆÿ™ÿ±ÿπ ÿÆŸàÿßÿ±ÿ≤ŸÖŸäÿ™Ÿä","ÿÆÿ∑ÿ£ 404: ÿßŸÑÿπÿ¥ÿ® ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ üåø","!ÿßŸÑÿπŸÑŸÖ ŸÜŸàÿ± üí°","!ÿßŸÑÿµÿ®ÿ± ŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑŸÅÿ±ÿ¨","!ÿ≥ÿ®ÿ≠ÿßŸÜ ÿßŸÑŸÑŸá","!ÿ¨ŸÖÿπÿ© ŸÖŸàŸàŸà-ÿ®ÿßÿ±ŸÉÿ© üïå","!ÿßÿ®ŸÜ ÿßŸÑŸáŸäÿ´ŸÖ ÿßÿÆÿ™ÿ±ÿπ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß üì∑","!ŸÖŸÜ ÿ¨ÿØ Ÿàÿ¨ÿØ üí™","ÿßŸÑÿ¨ÿ®ÿ± = Algebra üßÆ"],
};

const THEMES = {
  alhambra:    {label:{en:"Alhambra",fr:"Alhambra",ar:"ÿßŸÑÿ≠ŸÖÿ±ÿßÿ°"},bg:"#0a1628",card:"#0f2035",accent:"#d4a843",text:"#f0e6d0",muted:"#8a9ab5",keyBg:"#162a45",keyHov:"#1a3a5c",border:"#d4a843"},
  cordoba:     {label:{en:"C√≥rdoba",fr:"Cordoue",ar:"ŸÇÿ±ÿ∑ÿ®ÿ©"},bg:"#1a0a0a",card:"#2a1515",accent:"#c44040",text:"#f5ebe0",muted:"#b09080",keyBg:"#351e1e",keyHov:"#452828",border:"#c44040"},
  baghdad:     {label:{en:"Baghdad",fr:"Bagdad",ar:"ÿ®ÿ∫ÿØÿßÿØ"},bg:"#0a0a2e",card:"#111145",accent:"#f0c040",text:"#e8e0d0",muted:"#8888bb",keyBg:"#1a1a55",keyHov:"#252570",border:"#f0c040"},
  fez:         {label:{en:"Fez",fr:"F√®s",ar:"ŸÅÿßÿ≥"},bg:"#041830",card:"#082448",accent:"#4488ee",text:"#e0f0ff",muted:"#6699cc",keyBg:"#0a3060",keyHov:"#0d4080",border:"#4488ee"},
  isfahan:     {label:{en:"Isfahan",fr:"Ispahan",ar:"ÿ£ÿµŸÅŸáÿßŸÜ"},bg:"#041818",card:"#082828",accent:"#40c8c0",text:"#d8f0f0",muted:"#60a0a0",keyBg:"#0a3838",keyHov:"#0d4848",border:"#40c8c0"},
  ottoman:     {label:{en:"Ottoman",fr:"Ottoman",ar:"ÿπÿ´ŸÖÿßŸÜŸä"},bg:"#1a0810",card:"#2a1020",accent:"#e04050",text:"#f8e8e8",muted:"#c08080",keyBg:"#351828",keyHov:"#452238",border:"#e04050"},
  samarkand:   {label:{en:"Samarkand",fr:"Samarcande",ar:"ÿ≥ŸÖÿ±ŸÇŸÜÿØ"},bg:"#081820",card:"#0c2830",accent:"#50a0e0",text:"#d8e8f0",muted:"#6090a8",keyBg:"#103040",keyHov:"#184050",border:"#50a0e0"},
  timbuktu:    {label:{en:"Timbuktu",fr:"Tombouctou",ar:"ÿ™ŸÖÿ®ŸÉÿ™Ÿà"},bg:"#1a1408",card:"#2a2010",accent:"#d0a040",text:"#f0e8d0",muted:"#a09070",keyBg:"#352a18",keyHov:"#453820",border:"#d0a040"},
  madinah:     {label:{en:"Madinah",fr:"M√©dine",ar:"ÿßŸÑŸÖÿØŸäŸÜÿ©"},bg:"#041a08",card:"#082a10",accent:"#40c060",text:"#e0f8e8",muted:"#60a070",keyBg:"#0a3518",keyHov:"#0d4520",border:"#40c060"},
  arabianNight:{label:{en:"Arabian Night",fr:"Nuit Arabe",ar:"ŸÑŸäŸÑÿ© ÿπÿ±ÿ®Ÿäÿ©"},bg:"#060818",card:"#0a1028",accent:"#c0c8e8",text:"#d8d8f0",muted:"#7070a0",keyBg:"#101838",keyHov:"#182048",border:"#c0c8e8"},
  mughal:      {label:{en:"Mughal",fr:"Moghol",ar:"ŸÖÿ∫ŸàŸÑŸä"},bg:"#180a10",card:"#281418",accent:"#e0a0b0",text:"#f8e8f0",muted:"#b08090",keyBg:"#301820",keyHov:"#402028",border:"#e0a0b0"},
  domeOfRock:  {label:{en:"Dome of Rock",fr:"D√¥me du Rocher",ar:"ŸÇÿ®ÿ© ÿßŸÑÿµÿÆÿ±ÿ©"},bg:"#101828",card:"#182038",accent:"#e8c040",text:"#f0e8d0",muted:"#8090b0",keyBg:"#202848",keyHov:"#283860",border:"#e8c040"},
};

const I18N = {
  en:{appTitle:"CowSay Kids",say:"üó£Ô∏è Qul! (Say!)",think:"üí≠ Think",character:"Character",mood:"Mood",eyes:"Eyes",tongue:"Tongue",wrapWidth:"Width",copy:"üìã Copy",copied:"‚úÖ Copied!",clear:"Clear",random:"üé≤ Random",theme:"Theme",presets:"Presets",mashallah:"ŸÖÿß ÿ¥ÿßÿ° ÿßŸÑŸÑŸá!",placeholder:"Write something good..."},
  fr:{appTitle:"CowSay Enfants",say:"üó£Ô∏è Qul! (Dis!)",think:"üí≠ Penser",character:"Personnage",mood:"Humeur",eyes:"Yeux",tongue:"Langue",wrapWidth:"Largeur",copy:"üìã Copier",copied:"‚úÖ Copi√©!",clear:"Effacer",random:"üé≤ Al√©atoire",theme:"Th√®me",presets:"Messages",mashallah:"ŸÖÿß ÿ¥ÿßÿ° ÿßŸÑŸÑŸá!",placeholder:"√âcris quelque chose de bien..."},
  ar:{appTitle:"ÿ®ŸÇÿ±ÿ© ÿ™ÿ™ŸÉŸÑŸÖ",say:"!ŸÇŸèŸÑ üó£Ô∏è",think:"ŸÅŸÉŸëÿ± üí≠",character:"ÿ¥ÿÆÿµŸäÿ©",mood:"ŸÖÿ≤ÿßÿ¨",eyes:"ÿπŸäŸàŸÜ",tongue:"ŸÑÿ≥ÿßŸÜ",wrapWidth:"ÿπÿ±ÿ∂",copy:"ŸÜÿ≥ÿÆ üìã",copied:"!ÿ™ŸÖ ‚úÖ",clear:"ŸÖÿ≥ÿ≠",random:"ÿπÿ¥Ÿàÿßÿ¶Ÿä üé≤",theme:"ÿ≥ŸÖÿ©",presets:"ÿ±ÿ≥ÿßÿ¶ŸÑ",mashallah:"!ŸÖÿß ÿ¥ÿßÿ° ÿßŸÑŸÑŸá",placeholder:"...ÿßŸÉÿ™ÿ® ÿ¥Ÿäÿ¶ÿßŸã ÿ∑Ÿäÿ®ÿßŸã"},
};

// ========================
// STATE
// ========================
let state = {
  lang: "en",
  themeId: "alhambra",
  text: "ÿ®ÿ≥ŸÖ ÿßŸÑŸÑŸá",
  charId: "default",
  mood: "normal",
  customEyes: null,
  customTongue: null,
  wrapWidth: 30,
  isThink: false,
  capsLock: false,
};

// ========================
// COWSAY ENGINE
// ========================
function wordWrap(text, width) {
  if (!text) return [""];
  const words = text.split(" ");
  const lines = []; let cur = "";
  for (const w of words) {
    if (cur.length + w.length + 1 > width && cur.length > 0) { lines.push(cur); cur = w; }
    else { cur = cur ? cur + " " + w : w; }
  }
  if (cur) lines.push(cur);
  return lines.length ? lines : [""];
}

function makeBubble(text, width, think) {
  const lines = wordWrap(text, width);
  const max = Math.max(...lines.map(l => l.length));
  const pad = lines.map(l => l.padEnd(max));
  const b = think
    ? {tl:"(",tr:")",l:"(",r:")",bl:"(",br:")",top:"-",bot:"-",sl:"(",sr:")"}
    : {tl:"/",tr:"\\",l:"|",r:"|",bl:"\\",br:"/",top:"_",bot:"-",sl:"<",sr:">"};
  let out = " " + b.top.repeat(max + 2) + "\n";
  if (pad.length === 1) { out += `${b.sl} ${pad[0]} ${b.sr}\n`; }
  else { pad.forEach((ln, i) => {
    if (i === 0) out += `${b.tl} ${ln} ${b.tr}\n`;
    else if (i === pad.length - 1) out += `${b.bl} ${ln} ${b.br}\n`;
    else out += `${b.l} ${ln} ${b.r}\n`;
  }); }
  out += " " + b.bot.repeat(max + 2);
  return out;
}

function cowsay() {
  const ch = CHARACTERS[state.charId] || CHARACTERS.default;
  const m = MOODS[state.mood] || MOODS.normal;
  const eyes = state.customEyes || m.eyes;
  const tongue = state.customTongue || m.tongue;
  const bubble = makeBubble(state.text || " ", state.wrapWidth, state.isThink);
  return bubble + "\n" + ch.art(eyes, tongue);
}

// ========================
// THEME APPLICATION
// ========================
function applyTheme() {
  const th = THEMES[state.themeId];
  const r = document.documentElement.style;
  r.setProperty("--bg", th.bg);
  r.setProperty("--card", th.card);
  r.setProperty("--accent", th.accent);
  r.setProperty("--text", th.text);
  r.setProperty("--text-muted", th.muted);
  r.setProperty("--key-bg", th.keyBg);
  r.setProperty("--key-hover", th.keyHov);
  r.setProperty("--border", th.border);
  // Update SVG pattern
  document.querySelectorAll("#islamicGeo *").forEach(el => {
    if (el.getAttribute("stroke")) el.setAttribute("stroke", th.accent);
  });
}

// ========================
// RENDER FUNCTIONS
// ========================
function render() {
  document.getElementById("output-pre").textContent = cowsay();
}

function updateTextDisplay() {
  const el = document.getElementById("text-display");
  const dir = state.lang === "ar" ? "rtl" : "ltr";
  el.dir = dir;
  if (state.text) {
    el.innerHTML = escapeHtml(state.text) + '<span class="cursor">‚ñè</span>';
  } else {
    const t = I18N[state.lang];
    el.innerHTML = `<span style="color:var(--text-muted)">${t.placeholder}</span><span class="cursor">‚ñè</span>`;
  }
}

function escapeHtml(s) {
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

function renderAll() {
  applyTheme();
  render();
  updateTextDisplay();
  updateI18n();
  renderCharBtn();
}

function renderCharBtn() {
  const ch = CHARACTERS[state.charId];
  const btn = document.getElementById("char-btn");
  btn.textContent = ch.emoji + " " + (ch.name[state.lang] || ch.name.en);
}

function updateI18n() {
  const t = I18N[state.lang];
  document.getElementById("app-title").textContent = t.appTitle;
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    if (t[key]) el.textContent = t[key];
  });
  // Direction
  const dir = state.lang === "ar" ? "rtl" : "ltr";
  document.getElementById("app").dir = dir;
  document.documentElement.lang = state.lang;
  // Lang buttons
  document.querySelectorAll("[data-lang]").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.lang === state.lang);
  });
  // Wrap label
  document.getElementById("wrap-val").textContent = state.wrapWidth;
}

// ========================
// BUILD STATIC UI
// ========================
function buildMoodRow() {
  const row = document.getElementById("mood-row");
  row.innerHTML = "";
  Object.entries(MOODS).forEach(([id, m]) => {
    const btn = document.createElement("button");
    btn.className = "param-btn" + (state.mood === id && !state.customEyes ? " active" : "");
    btn.textContent = m.emoji + " " + (m.label[state.lang] || m.label.en);
    btn.onclick = () => { state.mood = id; state.customEyes = null; state.customTongue = null; buildMoodRow(); buildEyesRow(); buildTongueRow(); render(); };
    row.appendChild(btn);
  });
}

function buildEyesRow() {
  const row = document.getElementById("eyes-row");
  row.innerHTML = "";
  CUSTOM_EYES.forEach(e => {
    const btn = document.createElement("button");
    btn.className = "param-btn" + (state.customEyes === e ? " active" : "");
    btn.textContent = e;
    btn.style.fontFamily = "'VT323', monospace";
    btn.style.minWidth = "38px";
    btn.onclick = () => { state.customEyes = state.customEyes === e ? null : e; buildEyesRow(); render(); };
    row.appendChild(btn);
  });
}

function buildTongueRow() {
  const row = document.getElementById("tongue-row");
  row.innerHTML = "";
  CUSTOM_TONGUES.forEach(tg => {
    const btn = document.createElement("button");
    btn.className = "param-btn" + (state.customTongue === tg ? " active" : "");
    btn.textContent = tg.trim() || "‚Äî";
    btn.style.fontFamily = "'VT323', monospace";
    btn.style.minWidth = "38px";
    btn.onclick = () => { state.customTongue = state.customTongue === tg ? null : tg; buildTongueRow(); render(); };
    row.appendChild(btn);
  });
}

function buildKeyboard() {
  const kb = document.getElementById("keyboard");
  kb.innerHTML = "";
  const layout = KEYBOARDS[state.lang] || KEYBOARDS.en;
  layout.forEach((row, ri) => {
    const div = document.createElement("div");
    div.className = "kb-row";
    if (state.lang !== "ar") {
      div.style.paddingLeft = (ri === 2 ? "20px" : ri === 3 ? "44px" : "0");
      div.style.paddingRight = (ri === 2 ? "20px" : ri === 3 ? "44px" : "0");
    }
    row.forEach(key => {
      const btn = document.createElement("button");
      btn.className = "zellige-key";
      btn.textContent = state.capsLock && state.lang !== "ar" ? key.toUpperCase() : key;
      btn.onclick = () => { state.text += (state.capsLock && state.lang !== "ar" ? key.toUpperCase() : key); updateTextDisplay(); render(); };
      div.appendChild(btn);
    });
    kb.appendChild(div);
  });
  // Bottom row
  const bot = document.createElement("div");
  bot.className = "kb-row";
  const keys = [
    { label: "‚å´", cls: "special", style: "flex:0 0 60px;max-width:none", action: () => { state.text = state.text.slice(0, -1); } },
    { label: "‚îÄ‚îÄ‚îÄ ‚îÄ‚îÄ‚îÄ", cls: "space", style: "flex:1;max-width:260px", action: () => { state.text += " "; } },
    { label: ".", cls: "special", style: "flex:0 0 40px;max-width:none", action: () => { state.text += "."; } },
    { label: "!", cls: "special", style: "flex:0 0 40px;max-width:none", action: () => { state.text += "!"; } },
    { label: "?", cls: "special", style: "flex:0 0 40px;max-width:none", action: () => { state.text += "?"; } },
    { label: "ÿå", cls: "special", style: "flex:0 0 40px;max-width:none", action: () => { state.text += "ÿå"; } },
  ];
  keys.forEach(k => {
    const btn = document.createElement("button");
    btn.className = "zellige-key " + (k.cls || "");
    btn.style.cssText = k.style || "";
    btn.textContent = k.label;
    btn.onclick = () => { k.action(); updateTextDisplay(); render(); };
    bot.appendChild(btn);
  });
  kb.appendChild(bot);
}

function buildQuickKeys() {
  const row = document.getElementById("quick-keys");
  row.innerHTML = "";
  ISLAMIC_QUICK.forEach(k => {
    const btn = document.createElement("button");
    btn.className = "quick-key";
    btn.textContent = k.label;
    btn.onclick = () => { state.text = k.text; updateTextDisplay(); render(); };
    row.appendChild(btn);
  });
}

function buildCharDropdown() {
  const dd = document.getElementById("char-dropdown");
  dd.innerHTML = "";
  Object.entries(CHARACTERS).forEach(([id, ch]) => {
    const item = document.createElement("div");
    item.className = "drop-item" + (state.charId === id ? " active" : "");
    item.innerHTML = `<span style="font-size:18px">${ch.emoji}</span> <span>${ch.name[state.lang] || ch.name.en}</span>`;
    item.onclick = () => { state.charId = id; closeAllDropdowns(); buildCharDropdown(); renderCharBtn(); render(); };
    dd.appendChild(item);
  });
}

function buildThemeDropdown() {
  const dd = document.getElementById("theme-dropdown");
  dd.innerHTML = "";
  Object.entries(THEMES).forEach(([id, th]) => {
    const item = document.createElement("div");
    item.className = "drop-item" + (state.themeId === id ? " active" : "");
    item.innerHTML = `<span class="drop-swatch" style="background:${th.bg};border-color:${th.accent}"></span> <span>${th.label[state.lang] || th.label.en}</span>`;
    item.onclick = () => { state.themeId = id; closeAllDropdowns(); buildThemeDropdown(); renderAll(); };
    dd.appendChild(item);
  });
}

function buildPresetsDropdown() {
  const dd = document.getElementById("presets-dropdown");
  dd.innerHTML = "";
  (PRESETS[state.lang] || PRESETS.en).forEach(msg => {
    const item = document.createElement("div");
    item.className = "drop-item";
    item.textContent = msg;
    item.style.fontSize = "13px";
    item.onclick = () => { state.text = msg; closeAllDropdowns(); updateTextDisplay(); render(); };
    dd.appendChild(item);
  });
}

// ========================
// ACTIONS
// ========================
function setLang(lang) {
  state.lang = lang;
  buildKeyboard();
  buildMoodRow();
  buildCharDropdown();
  buildThemeDropdown();
  buildPresetsDropdown();
  renderAll();
}

function setMode(think) {
  state.isThink = think;
  document.getElementById("say-btn").classList.toggle("active", !think);
  document.getElementById("think-btn").classList.toggle("active", think);
  render();
}

function setWrapWidth(val) {
  state.wrapWidth = parseInt(val);
  document.getElementById("wrap-val").textContent = val;
  render();
}

function clearText() {
  state.text = "";
  updateTextDisplay();
  render();
}

function toggleCaps() {
  state.capsLock = !state.capsLock;
  document.getElementById("caps-btn").classList.toggle("active", state.capsLock);
  buildKeyboard();
}

function randomCombo() {
  const msgs = PRESETS[state.lang] || PRESETS.en;
  const chars = Object.keys(CHARACTERS);
  const moods = Object.keys(MOODS);
  state.text = msgs[Math.floor(Math.random() * msgs.length)];
  state.charId = chars[Math.floor(Math.random() * chars.length)];
  state.mood = moods[Math.floor(Math.random() * moods.length)];
  state.customEyes = null;
  state.customTongue = null;
  buildMoodRow(); buildEyesRow(); buildTongueRow(); buildCharDropdown();
  renderCharBtn(); updateTextDisplay(); render();
}

function copyOutput() {
  const text = document.getElementById("output-pre").textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById("copy-btn");
    const t = I18N[state.lang];
    btn.querySelector("span").textContent = t.copied;
    setTimeout(() => { btn.querySelector("span").textContent = t.copy; }, 1500);
  });
}

// ========================
// DROPDOWNS
// ========================
function toggleDropdown(id) {
  const dd = document.getElementById(id);
  const isOpen = dd.classList.contains("open");
  closeAllDropdowns();
  if (!isOpen) dd.classList.add("open");
}

function closeAllDropdowns() {
  document.querySelectorAll(".dropdown").forEach(d => d.classList.remove("open"));
}

document.addEventListener("click", (e) => {
  if (!e.target.closest(".dropdown-wrap")) closeAllDropdowns();
});

// ========================
// PHYSICAL KEYBOARD SUPPORT
// ========================
document.addEventListener("keydown", (e) => {
  if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") return;
  if (e.key === "Backspace") { e.preventDefault(); state.text = state.text.slice(0, -1); updateTextDisplay(); render(); }
  else if (e.key === "Enter") { e.preventDefault(); }
  else if (e.key.length === 1) { state.text += e.key; updateTextDisplay(); render(); }
});

// ========================
// INIT
// ========================
window.addEventListener("DOMContentLoaded", () => {
  // Build everything
  buildMoodRow();
  buildEyesRow();
  buildTongueRow();
  buildKeyboard();
  buildQuickKeys();
  buildCharDropdown();
  buildThemeDropdown();
  buildPresetsDropdown();
  renderAll();

  // Splash screen
  setTimeout(() => {
    document.getElementById("splash").classList.add("hidden");
  }, 2300);
});
</script>
</body>
</html>
